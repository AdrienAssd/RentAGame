---
import GameCard from '../components/GameCard.astro';
import Layout from '../layouts/Layout.astro';
// R√©cup√©ration des cat√©gories depuis l'API
const categoriesResponse = await fetch(`${import.meta.env.PUBLIC_BACKEND_URL}/api/categories`);
const categories = await categoriesResponse.json();

// Appel API pour r√©cup√©rer les jeux (avec pagination)
const page = 1;
const limit = 10;
const response = await fetch(`${import.meta.env.PUBLIC_BACKEND_URL}/api/games?page=${page}&limit=${limit}`, {
  credentials: 'include',
});
const games = await response.json();
---
<Layout>
  <header class="flex justify-between items-center p-4 shadow bg-white">
    <div class="flex items-center gap-2">
      <img src="/images/LogoRentAGame.png" alt="Logo" class="h-10">
      <h1 class="text-xl font-bold">Liste des jeux</h1>
    </div>
    <nav class="space-x-4">
      <a href="/" class="font-medium">Liste des jeux</a>
      <a href="/apropos" class="text-gray-600 hover:text-black">√Ä propos</a>
      <a href="/contact" class="text-gray-600 hover:text-black">Contact</a>
      <a href="/login" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800 hidden" id="login-btn">Connexion</a>
    </nav>
  </header>
  <div class="flex">

    <main class="flex-1 p-6">
      <!-- Barre de recherche -->
      <div class="mb-4 flex items-center gap-2">
        <input 
          type="text" 
          id="search-input" 
          placeholder="Rechercher un jeu..." 
          class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-purple-400"
        />
        <button 
          id="search-button" 
          class="p-2 bg-purple-600 text-white rounded-full hover:bg-purple-700"
          title="Rechercher"
        >
          üîç
        </button>
      </div>

      <!-- Menu d√©roulant des cat√©gories -->
      <div class="mb-4">
        <select id="category-select" class="px-4 py-2 border rounded">
          <option value="">Toutes les cat√©gories</option>
          {categories.map((cat: any) => (
            <option value={cat}>{cat}</option>
          ))}
        </select>
      </div>

      <div id="games-list" class="grid grid-cols-5 gap-4">
        {games.map((game: any) => (
          <GameCard 
            key={game.slug}
            title={game.title} 
            image={game.image} 
            slug={game.slug} 
            minplayers={game.minplayers} 
            maxplayers={game.maxplayers} 
            minage={game.minage}
            description={game.description}
          />
        ))}
      </div>

      <button id="load-more" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
        Afficher plus
      </button>
    </main>
  </div>

    <script type="module">
    window.addEventListener('DOMContentLoaded', () => {
      // ‚Äî Variables DOM ‚Äî
      const loadMoreButton  = document.getElementById('load-more');
      const gamesList       = document.getElementById('games-list');
      const searchInput     = document.getElementById('search-input');
      const searchButton    = document.getElementById('search-button');
      const categorySelect  = document.getElementById('category-select');
  
      console.log({ loadMoreButton, searchInput, searchButton, categorySelect });
  
      // ‚Äî √âtat de pagination et filtre ‚Äî
      let currentPage     = 1;
      let currentCategory = '';
      const limit         = 10;
  
      // ‚Äî Helpers HTML ‚Äî
      function createGameCardHtml(game) {
        return `
          <a href="/game/${game.slug}" class="game-card-link">
            <article class="game-card">
              <div class="bg-white rounded shadow p-2" id="${game.slug}">
                <img src="${game.image}" alt="${game.title}" class="w-full h-32 object-cover rounded" loading="lazy" />
                <h2 class="text-sm font-bold mt-2">${game.title}</h2>
                <div class="flex justify-between items-center text-xs text-gray-500">
                  <span>${game.minplayers} - ${game.maxplayers} joueurs</span>
                  <span>${game.minage}+</span>
                </div>
              </div>
            </article>
          </a>
        `;
      }
      function renderGames(games) {
        gamesList.innerHTML += games.map(createGameCardHtml).join('');
      }
  
      // ‚Äî Chargement des jeux (avec filtre cat√©gorie) ‚Äî
      async function loadGamesPage(page) {
        const catQuery = currentCategory
          ? `&category=${encodeURIComponent(currentCategory)}`
          : '';
        console.log(`Chargement page ${page} (cat="${currentCategory}")`);
        const res = await fetch(
          `${import.meta.env.PUBLIC_BACKEND_URL}/api/games?page=${page}&limit=${limit}${catQuery}`,
          { credentials: 'include' }
        );
        const newGames = await res.json();
        console.log('Jeux re√ßus :', newGames);
        renderGames(newGames);
        if (newGames.length < limit) {
          loadMoreButton.disabled   = true;
          loadMoreButton.textContent = 'Tous les jeux sont affich√©s';
        }
      }
  
      // ‚Äî Bouton ¬´ Afficher plus ¬ª ‚Äî
      loadMoreButton.addEventListener('click', async () => {
        currentPage++;
        await loadGamesPage(currentPage);
      });
  
      // ‚Äî Recherche textuelle ‚Äî
      async function searchGames(query) {
        // Reset √©tat
        currentCategory = '';
        gamesList.innerHTML = '';
        currentPage = 1;
        // Ici tu pourrais appeler une route /api/search?query=‚Ä¶
        // Pour l‚Äôexemple on recharge juste la page 1 de /api/games
        await loadGamesPage(1);
      }
      searchButton.addEventListener('click', () => {
        const q = searchInput.value.trim();
        if (q) searchGames(q);
      });
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const q = searchInput.value.trim();
          if (q) searchGames(q);
        }
      });
  
      // ‚Äî Filtrage par cat√©gorie ‚Äî
      categorySelect.addEventListener('change', async (e) => {
        const cat = e.target.value;
        gamesList.innerHTML = '';
        currentPage     = 1;
        loadMoreButton.disabled = false;
        loadMoreButton.textContent = 'Afficher plus';
        if (!cat) {
          currentCategory = '';
        } else {
          currentCategory = cat;
        }
        await loadGamesPage(1);
      });
  
      // ‚Äî Chargement initial ‚Äî
      loadGamesPage(1);
    });
  </script>
</Layout>
