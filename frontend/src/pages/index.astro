---
import GameCard from '../components/GameCard.astro';
import Layout from '../layouts/Layout.astro';

// R√©cup√©ration des cat√©gories depuis l'API
const categoriesResponse = await fetch(`https://rentagame-production-81ca.up.railway.app/api/categories`);
const categories = await categoriesResponse.json();

// R√©cup√©ration de la premi√®re page de jeux
const page = 1;
const limit = 10;
const response = await fetch(`https://rentagame-production-81ca.up.railway.app/api/games?page=${page}&limit=${limit}`, {
  credentials: 'include',
});
const initialGames = await response.json();
---

<Layout>
  <header class="flex justify-between items-center p-4 shadow bg-white">
    <div class="flex items-center gap-2">
      <img src="/images/LogoRentAGame.png" alt="Logo" class="h-10">
      <h1 class="text-xl font-bold">Liste des jeux</h1>
    </div>
    <nav class="space-x-4">
      <a href="/" class="font-medium">Liste des jeux</a>
      <a href="/apropos" class="text-gray-600 hover:text-black">√Ä propos</a>
      <a href="/contact" class="text-gray-600 hover:text-black">Contact</a>
      <a href="/login" class="bg-black text-white px-4 py-2 rounded hover:bg-gray-800 hidden" id="login-btn">Connexion</a>
    </nav>
  </header>

  <div class="flex">
    <main class="flex-1 p-6">
      <!-- Barre de recherche -->
      <div class="mb-4 flex items-center gap-2">
        <input 
          type="text" 
          id="search-input" 
          placeholder="Rechercher un jeu..." 
          class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-purple-400"
        />
        <button 
          id="search-button" 
          class="p-2 bg-purple-600 text-white rounded-full hover:bg-purple-700"
          title="Rechercher"
        >
          üîç
        </button>
      </div>

      <!-- Menu d√©roulant des cat√©gories -->
      <div class="mb-4">
        <select id="category-select" class="px-4 py-2 border rounded">
          <option value="">Toutes les cat√©gories</option>
          {categories.map((cat: any) => (
            <option value={cat}>{cat}</option>
          ))}
        </select>
      </div>

      <div id="games-list" class="grid grid-cols-5 gap-4">
        {initialGames.map((game: any) => (
          <GameCard 
            key={game.slug}
            title={game.title} 
            image={game.image} 
            slug={game.slug} 
            minplayers={game.minplayers} 
            maxplayers={game.maxplayers} 
            minage={game.minage}
            description={game.description}
          />
        ))}
      </div>

      <button id="load-more" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
        Afficher plus
      </button>
    </main>
  </div>

  <script is:inline type="module">
    window.addEventListener('DOMContentLoaded', () => {
      const loadMoreButton  = document.getElementById('load-more');
      const gamesList       = document.getElementById('games-list');
      const searchInput     = document.getElementById('search-input');
      const searchButton    = document.getElementById('search-button');
      const categorySelect  = document.getElementById('category-select');

      let currentPage       = 1;
      let currentCategory   = '';
      let searchQuery       = '';
      const limit           = 10;

      function createGameCardHtml(game) {
        return `
          <a href="/game/${game.slug}" class="game-card-link">
            <article class="game-card">
              <div class="bg-white rounded shadow p-2" id="${game.slug}">
                <img src="${game.image}" alt="${game.title}" class="w-full h-32 object-cover rounded" loading="lazy" />
                <h2 class="text-sm font-bold mt-2">${game.title}</h2>
                <div class="flex justify-between items-center text-xs text-gray-500">
                  <span>${game.minplayers} - ${game.maxplayers} joueurs</span>
                  <span>${game.minage}+</span>
                </div>
              </div>
            </article>
          </a>
        `;
      }

      function renderGames(games) {
        gamesList.innerHTML += games.map(createGameCardHtml).join('');
      }

      async function loadGamesPage(page) {
        const catQuery = currentCategory
          ? `&category=${encodeURIComponent(currentCategory)}`
          : '';
        const searchQueryStr = searchQuery
          ? `&search=${encodeURIComponent(searchQuery)}`
          : '';
        const res = await fetch(
          `https://rentagame-production-81ca.up.railway.app/api/games?page=${page}&limit=${limit}${catQuery}${searchQueryStr}`,
          { credentials: 'include' }
        );
        const newGames = await res.json();
        renderGames(newGames);
        if (newGames.length < limit) {
          loadMoreButton.disabled = true;
          loadMoreButton.textContent = 'Tous les jeux sont affich√©s';
        }
      }

      loadMoreButton.addEventListener('click', async () => {
        currentPage++;
        await loadGamesPage(currentPage);
      });

      searchButton.addEventListener('click', () => {
        searchQuery = searchInput.value.trim();
        currentPage = 1;
        gamesList.innerHTML = '';
        loadMoreButton.disabled = false;
        loadMoreButton.textContent = 'Afficher plus';
        loadGamesPage(currentPage);
      });

      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          searchQuery = searchInput.value.trim();
          currentPage = 1;
          gamesList.innerHTML = '';
          loadMoreButton.disabled = false;
          loadMoreButton.textContent = 'Afficher plus';
          loadGamesPage(currentPage);
        }
      });

      categorySelect.addEventListener('change', async (e) => {
        currentCategory = e.target.value || '';
        currentPage = 1;
        gamesList.innerHTML = '';
        loadMoreButton.disabled = false;
        loadMoreButton.textContent = 'Afficher plus';
        await loadGamesPage(currentPage);
      });
    });
  </script>
</Layout>
